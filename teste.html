<html>
    <head>
        <title>TODO supply a title</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script type="text/javascript" src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
        <style>
            th{
                background-color: #ffcccc;
            }
        </style>
    </head>
    <body>
        <div>TODO write content</div>
        <input type="text" id="sname" name="sname" placeholder="Enter student name">
        <input type="text" id="ssub" name="ssub" placeholder="Enter subject">
        <button id="edit" onclick="editClicked()">Edit</button>
        <button id="add" onclick="addStudentRecord()">Insert Record</button>
        <button onclick="getAllStudentRecords()" id="reload">Get All Records</button>
        <div>
            <table>
                <thead>
                    <tr>
                        <th>SId</th>
                        <th>Name</th>
                        <th>Sub</th>
                        <th colspan="2">Action</th>
                    </tr>
                </thead>
                <tbody>

                </tbody>
            </table>
        </div>

        <script>
            $("#edit").hide();
            var request = window.indexedDB.open("mystd.db", 1);
            var stdObj = {};
            var db;

            request.onsuccess = function (event) {
                db = event.target.result;
                getAllStudentRecords();
            };

            request.onerror = function (event) {

            };

            request.onupgradeneeded = function (event) {
                //newly created db
                db = event.target.result;
                var objectStore = db.createObjectStore("stdTbl", {keyPath: "stdId", autoIncrement: true});
                objectStore.createIndex("stdName", "stdName", {unique: false}); // defines field and gives indexing capability
                objectStore.createIndex("stdSub", "stdSub", {unique: false});
                getAllStudentRecords();
            };

            function addStudentRecord() {
                var transaction = db.transaction(["stdTbl"], "readwrite");
                var objectStore = transaction.objectStore("stdTbl");
                var stdname = $("#sname").val();
                var stdsub = $("#ssub").val();
                var stdData = {stdName: stdname, stdSub: stdsub};

                /*
                 var stdData = {};
                 stdData["stdName"] = stdname;
                 stdData["stdSub"] = stdsub;
                 */
                var request = objectStore.add(stdData);

                request.onsuccess = function (event) {
                    console.log(event.target.result);

                    getAllStudentRecords();
                };
            }

            function getAllStudentRecords() {
                var transaction = db.transaction(["stdTbl"], "readonly");
                var objectStore = transaction.objectStore("stdTbl");
                var request = objectStore.openCursor(null, "prev"); //Query, Order
                $("#sname").val("");
                $("#ssub").val("");
                $("tbody").empty();
                $("#edit").hide();
                $("#reload").html("Get All Records");
                $("#add").show();
                stdObj = {};
                request.onsuccess = function (event) {
                    var cursor = event.target.result;
                    if (cursor) {
                        console.log(cursor.value);
                        var tr = jQuery("<tr></tr>");
                        var std = jQuery("<td>" + cursor.value.stdId + "</td>");
                        var stdName = jQuery("<td>" + cursor.value.stdName + "</td>");
                        var stdSub = jQuery("<td>" + cursor.value.stdSub + "</td>");
                        var stdEdit = jQuery("<td></td>");
                        var stdEditButton = jQuery("<button>Edit</button>");
                        stdEditButton.appendTo(stdEdit);
                        var stdDelete = jQuery("<td></td>");
                        var stdDelButton = jQuery("<button>Delete</button>");
                        stdDelButton.appendTo(stdDelete);

                        std.appendTo(tr);
                        stdName.appendTo(tr);
                        stdSub.appendTo(tr);
                        stdEdit.appendTo(tr);
                        stdDelete.appendTo(tr);

                        $("tbody").append(tr);

                        stdEditButton.click({stdObj: cursor.value}, function (e) {
                            editStudentRecord(e.data.stdObj);
                        });

                        stdDelButton.click({stdObj: cursor.value}, function (e) {
                            removeStudentRecord(e.data.stdObj);
                        });
                        cursor.continue();
                    }
                };
            }

            function editClicked() {

                var transaction = db.transaction(["stdTbl"], "readwrite");
                var stdObjectStore = transaction.objectStore("stdTbl");
                stdObj.stdName = $("#sname").val();
                stdObj.stdSub = $("#ssub").val();

                var request = stdObjectStore.put(stdObj);

                request.onsuccess = function (event) {
                    getAllStudentRecords();
                };
            }

            function editStudentRecord(stdOb) {
                stdObj = stdOb;
                $("#edit").show();
                $("#reload").html("Cancel");
                $("#add").hide();
                $("#sname").val(stdObj.stdName);
                $("#ssub").val(stdObj.stdSub);

            }

            function removeStudentRecord(stdOb) {
                stdObj = stdOb;
                var transaction = db.transaction(["stdTbl"], "readwrite");
                var stdObjectStore = transaction.objectStore("stdTbl");
                

                var request = stdObjectStore.delete(stdObj.stdId);

                request.onsuccess = function (event) {
                    getAllStudentRecords();
                };
            }

        </script>
    </body>
</html>