<!DOCTYPE html>
<html>

<head>
	<title>Garantia</title>
	<script type="text/javascript" src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
	<!-- <script type="text/javascript" src="http://code.jquery.com/jquery-3.1.1.min.js"></script> -->

	<script type="text/javascript">
		$(document).ready(function () {
			window.indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB;
			var request, db;
			if (!window.indexedDB) {
				console.log("Seu navegador n√£o suporta o recurso HTML5 IndexedDB");
			} else {
				request = window.indexedDB.open("garantia", 2);
				request.onerror = function (event) {
					console.log("Erro ao abrir o banco de dados", event);
				}

				request.onupgradeneeded = function (event) {
					console.log("Atualizando");
					db = event.target.result;
					//var objectStore = db.createObjectStore("garantia", { keyPath : "codigo" });
					var objectStore = db.createObjectStore("garantia", { keyPath: "id", autoIncrement: true });
				};
				request.onsuccess = function (event) {
					console.log("Banco de dados aberto com sucesso :)");
					db = event.target.result;
				}
			}

			//botao adicionar
			$("#addBtn").click(function () {
				//var codigo = $("#codigo").val(); Nao vai mais porque estou usando autoIncrement
				var produto = $("#produto").val();
				var loja = $("#loja").val();
				var tmpGarantia = parseInt($("#tmpGarantia").val());
				var radioBtn = $("input[name='radioBtn']:checked").val();
				var transaction = db.transaction(["garantia"], "readwrite");
				console.log(radioBtn);
				tmpGarantia = (tmpGarantia * radioBtn);
				console.log(tmpGarantia);
				transaction.oncomplete = function (event) {
					console.log("addBtn: Registro Adicionado com Sucesso ");
					$("#result").html("Registro Adicionado com Sucesso");

					setTimeout(function () {
						$("#result").html("");
					}, 2000);
				};

				transaction.onerror = function (event) {
					console.log("Erro :(");
					$("#result").html("Erro ao Adicionar");
				};

				var objectStore = transaction.objectStore("garantia");
				objectStore.add({ produto: produto, loja: loja, tmpGarantia: tmpGarantia });
			});

			//botao listar
			$("#listBtn").click(function () {
				$("#tabela").html("");
				var transaction = db.transaction("garantia", "readonly");
				var objectStore = transaction.objectStore("garantia");
				var request = objectStore.openCursor();

				request.onsuccess = function () {
					var cursor = request.result;

					if (cursor) {
						$("#tabela").append("<tr><td>" + cursor.value.id +
							"</td><td>" + cursor.value.produto + "</td>" +
							"<td>" + cursor.value.loja + "</td>" +
							"<td>" + cursor.value.tmpGarantia+" dias"+ "</td>");
							//"<td><button>Editar</button> <button name=\"removeBtn\" id=\"removeBtn\">Remover</button></td>");
						cursor.continue();
					} else {
						console.log("Nao tem mais objetos");
					}
				};
			})

			//Botao remover
			$("#removeBtn").click(function () {
				var codigo = parseInt($("#codigo").val());
				var transaction = db.transaction(["garantia"], "readwrite");
				var objectStore = transaction.objectStore("garantia");
				var request = objectStore.delete(codigo);

				request.oncomplete = function (event) {
					$("#result").html("removido com sucesso");
					console.log("removeBtn: Removido com sucesso");
					console.log(request.result);
				};
			});

				//Botao getBtn
			$("#getBtn").click(function () {
				console.log("#getBtn")
				var codigo = $("#codigo").val();
				var request = db.transaction(["garantia"], "readwrite").objectStore("garantia").get(18);
							
				request.onsuccess = function (event) {
				$("#result").html("produto: "+request.result.produto);
				};
			});

			//Botao Update
			/*			$("updateBtn").click(function () {
							var codigo = parseInt($("#codigo").val());
							var transaction = db.transaction(["garantia"], "readwrite");
							var objectStore = transaction.objectStore("garantia");
							var request = objectStore.get(codigo);
			
							request.onsucess = function (event) {
								$("#request").html("Atualizando: " + request.result.produto + "para " + produto);
								request.result.produto = produto;
								objectStore.put(request.result);
							};
						})
			*/
		});
	</script>
</head>

<body>
	<form>
		<table border="0" width="100%">
			<tr>
				<td colspan="3">
					<hr>
				</td>
			</tr>
			<tr>
				<td width="12%">Codigo</td>
				<td colspan="2"> <input type="text" name="codigo" id="codigo" /></td>
			</tr>
			<tr>
				<td width="12%">Produto</td>
				<td colspan="2"> <input type="text" name="produto" id="produto" /></td>
			</tr>

			<tr>
				<td width="12%">Loja</td>
				<td colspan="2"> <input type="text" name="loja" id="loja" /></td>
			</tr>

			<tr>
				<td width="12%">Tempo de Garantia</td>
				<td colspan="2"> <input type="text" name="tmpGarantia" id="tmpGarantia" /> Mes
					<input type="radio" name="radioBtn" value=30 id="garantiaMes" /> Ano
					<input type="radio" name="radioBtn" value=365 id="garantiaAno" />
				</td>
			</tr>

			<tr>
				<td width="12%">&nbsp;</td>
				<td>
					<input type="button" name="addBtn" value="Adicionar" id="addBtn" />
					<input type="button" name="removeBtn" value="Remover" id="removeBtn_" />
					<!-- <input type="button" name="updateBtn" value="Atualizar" id="updateBtn" /> -->
					<input type="button" name="listBtn" value="Listar" id="listBtn" />
					<input type="button" name="getBtn" value="getBtn" id="getBtn" />
				</td>
				<td width="3%">&nbsp;</td>
			</tr>
		</table>
	</form>
	<div id="result"></div>

	<table>
		<thead>
			<tr>
				<th>ID</th>
				<th>Produto</th>
				<th>Loja</th>
				<th>Tempo de Garantia</th>
			</tr>
			<tbody id="tabela">
			</tbody>
		</thead>
	</table>

</body>

</html>