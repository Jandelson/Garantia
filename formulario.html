<!DOCTYPE html>
<html>

<head>
	<title>Garantia</title>
	<script type="text/javascript" src="http://code.jquery.com/jquery-3.1.1.min.js"></script>
	<script type="text/javascript">
	
		var request = window.indexedDB.open("garantia",2);
		var db;
		var obj = {};
		
		function removerItemGarantia(objeto) {
			obj = objeto;
			var transaction = db.transaction(["garantia"], "readwrite");
			var objectStore = transaction.objectStore("garantia");
			var request = objectStore.delete(obj.id);
			mostraListaGarantia();

			request.onsucess = function (event) {
				console.log("listarGarantia");
			};
		} //fim removerItemGarantia

		function limpaForm(){
			$("#produto").val("");
			$("#loja").val("");
			$("#tmpGarantia").val("");
		}//fim limaForm

		function editarItemGarantia(objeto) {
			obj = objeto;
			$("#produto").val(obj.produto);
			$("#loja").val(obj.loja);
			$("#tmpGarantia").val(obj.tmpGarantia);
		} //fim editorItemGarantia

		function mostraListaGarantia() {
			$("#tabelaGarantia").html("");
				console.log("abriu a funcao mostraListaGarantia");
				var transaction = db.transaction(["garantia"], "readonly");
				var objectStore = transaction.objectStore("garantia");
				var request = objectStore.openCursor();

				request.onsuccess = function () {
					var cursor = request.result;

					if(cursor) {
						var tr = jQuery("<tr></tr>");
						var td = jQuery("<td>"+ cursor.value.id+ "</td>");
						var tdProduto = jQuery("<td>"+cursor.value.produto+"</td>");
						var tdLoja = jQuery("<td>"+cursor.value.loja+"</td>");
						var tdTmpGarantia = jQuery("<td>"+cursor.value.tmpGarantia+"</td>");
						var tdEdit = jQuery("<td></td>");
						var tdEditButton = jQuery("<button>Editar</button>");
						tdEditButton.appendTo(tdEdit);
						var tdDelete = jQuery("<td></td>");
						var tdDeleteButton = jQuery("<button>Deletar</button>");
						tdDeleteButton.appendTo(tdDelete);
						
						td.appendTo(tr);
						tdProduto.appendTo(tr);
						tdLoja.appendTo(tr);
						tdTmpGarantia.appendTo(tr);
						tdEdit.appendTo(tr);
						tdDelete.appendTo(tr);
						
						$("#tabelaGarantia").append(tr);

					tdEditButton.click({obj: cursor.value}, function (event) {
						editarItemGarantia(event.data.obj);	
					});

					tdDeleteButton.click({obj: cursor.value}, function (event) {
						removerItemGarantia(event.data.obj);
					});

					cursor.continue();
					} else {
						console.log("Nao tem mais objetos");
					}
				};
			} //fim mostraListaGarantia
		
		//indexedDB
		$(document).ready(function () {
			window.indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB;

			if (!window.indexedDB){
				console.log("Seu navegador não suporta o recurso HTML5 IndexedDB");
			}else{
				request.onerror = function (event) {
					console.log("Erro ao abrir o banco de dados", event);
				};

				request.onupgradeneeded = function (event) {
					console.log("Atualizando");
					db = event.target.result;
					var objectStore = db.createObjectStore("garantia", { keyPath: "id", autoIncrement: true });
				};

				request.onsuccess = function (event) {
					console.log("Banco de dados aberto com sucesso :)");
					db = event.target.result;

				};
			}
				
			//botao adicionar
			$("#addBtn").click(function (){
				var produto = $("#produto").val();
				var loja = $("#loja").val();
				var tmpGarantia = parseInt($("#tmpGarantia").val());
				var radioBtn = $("input[name='radioBtn']:checked").val();
				var transaction = db.transaction(["garantia"], "readwrite");
				console.log(radioBtn);
				tmpGarantia = (tmpGarantia * radioBtn);
				console.log(tmpGarantia);
				
				transaction.oncomplete = function (event) {
					console.log("addBtn: Registro Adicionado com Sucesso ");
					$("#result").html("Registro Adicionado com Sucesso");
					mostraListaGarantia();
					//limpaForm();

					setTimeout(function () {
						$("#result").html("");
					}, 2000);
				};

				transaction.onerror = function (event) {
					console.log("Erro :( ");
					$("#result").html("Erro ao Adicionar");
				};

				var objectStore = transaction.objectStore("garantia");
				objectStore.add({ produto: produto, loja: loja, tmpGarantia: tmpGarantia });
			}); //fim adicionar
		}); //fim indexedDB
	</script>
</head>

<html>
<body>
	<form id="formulario" method="post">
		<table border="0" width="100%">
			<tr>
				<td colspan="3">
					<hr>
				</td>
			</tr>
			<tr>
				<td width="12%">Codigo</td> 
				<td colspan="2"> <input type="text" name="codigo" id="codigo" /> Não usar para cadastrar</td>
			</tr>
			<tr>
				<td width="12%">Produto</td>
				<td colspan="2"> <input type="text" name="produto" id="produto" /></td>
			</tr>

			<tr>
				<td width="12%">Loja</td>
				<td colspan="2"> <input type="text" name="loja" id="loja" /></td>
			</tr>

			<tr>
				<td width="12%">Tempo de Garantia</td>
				<td colspan="2"> <input type="text" name="tmpGarantia" id="tmpGarantia" /> Meses
					<input type="radio" name="radioBtn" checked value=30 id="garantiaMes" /> Anos
					<input type="radio" name="radioBtn" value=365 id="garantiaAno" />
				</td>
			</tr>

			<tr>
				<td width="12%">&nbsp;</td>
				<td>
					<input type="button" name="addBtn" value="Adicionar" id="addBtn" />
					<input type="button" name="removeBtn" value="Remover" id="removeBtn" />
					<input type="button" onclick="mostraListaGarantia()" name="listBtn" value="Listar" id="listBtn" />
					<input type="button" name="getBtn" value="getBtn" id="getBtn" />
					<button id="edit" onclick="editClicked()">Edit</button>
				</td>
				<td width="3%">&nbsp;</td>
			</tr>
		</table>
	</form>
	<div id="result"></div>

	<table>
		<thead>
			<tr>
				<th>ID</th>
				<th>Produto</th>
				<th>Loja</th>
				<th>Tempo de Garantia</th>
			</tr>
			<tbody id="tabelaGarantia">
			</tbody>
		</thead>
	</table>
</body>
</html>